package xapi.dev.ui.api;

import com.github.javaparser.ast.type.Type;
import xapi.collect.X_Collect;
import xapi.collect.api.StringTo;
import xapi.dev.source.ClassBuffer;
import xapi.dev.source.SourceBuilder;
import xapi.dev.ui.impl.UiGeneratorTools;
import xapi.model.api.Model;
import xapi.source.read.JavaModel.IsTypeDefinition;
import xapi.util.X_String;

/**
 * Created by James X. Nelson (james @wetheinter.net) on 2/10/17.
 */
public class GeneratedUiModel extends GeneratedJavaFile {
    private final StringTo<GeneratedUiField> fields;
    private String nameOverride;

    public GeneratedUiModel(GeneratedUiComponent owner, String packageName, String className) {
        this(owner, null, packageName, className);
    }

    public GeneratedUiModel(GeneratedUiComponent owner, GeneratedJavaFile superType, String packageName, String className) {
        super(owner, superType, packageName, className);
        fields = X_Collect.newStringMap(GeneratedUiField.class);
        setType(IsTypeDefinition.newInterface(packageName, className));
    }

    public StringTo<GeneratedUiField> getFields() {
        return fields;
    }

    @Override
    public boolean isInterface() {
        return true;
    }

    @Override
    protected SourceBuilder<GeneratedJavaFile> createSource() {
        final SourceBuilder<GeneratedJavaFile> source = super.createSource();
        final IsTypeDefinition type = IsTypeDefinition.newInterface(getPackageName(), getWrappedName());
        source.setClassDefinition(type.toDefinition(), false);
        source.setPackage(type.getPackage());
        source.getClassBuffer().addInterface(Model.class);
        assert source.toSource().contains("interface");
        return source;
    }

    @Override
    protected String wrapName(String className) {
        return nameOverride == null ? "Model" + className : nameOverride;
    }

    public GeneratedUiField addField(UiGeneratorTools tools, Type type, String fieldName, boolean immutable) {
        final GeneratedUiField newField = new GeneratedUiField(type, fieldName);
        fields.put(fieldName, newField);

        final ClassBuffer buf = getSource().getClassBuffer();
        String typeName = tools.lookupType(type.toSource());
        if (typeName.contains(".")) {
            typeName = buf.addImport(typeName);
        }
        String capitalized = X_String.toTitleCase(fieldName);
        buf.createMethod(typeName + " get" + capitalized)
            .makeAbstract();
        if (!immutable) {
            buf.createMethod("public " + typeName + " set" + capitalized)
                .addParameter(typeName, fieldName)
                .makeAbstract();
            if (typeName.contains("[]")) {
                // TODO We'll need adders, removers and clear

            } else if (
                tools.allListTypes().anyMatch(typeName::equals)
                ) {
                // TODO We'll need adders, removers and clear


            }
        }

        return newField;
    }

    @Override
    public boolean shouldSaveType() {
        return !fields.isEmpty();
    }

    public GeneratedUiField getField(String name) {
        return fields.get(name);
    }

    public void overrideName(String name) {
        this.nameOverride = name;
    }
}
